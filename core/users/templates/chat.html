<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NexChat â€” Live Chat</title>
  <meta name="description" content="Real-time chat powered by Django Channels." />
  {% load static %}
  <link rel="stylesheet" href="{% static 'css/chat.css' %}" />
</head>

<body>

  <!-- â”€â”€ Toast Container â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="toast-container" id="toastContainer"></div>

  <div class="chat-page">

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       HEADER
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <header class="chat-header">
      <div class="chat-header-left">
        <div class="brand">
          <div class="brand-icon">ğŸ’¬</div>
          NexChat
        </div>
      </div>
      <div class="chat-header-right">
        <div class="connection-badge disconnected" id="connBadge">
          <div class="conn-dot"></div>
          <span id="connText">Connectingâ€¦</span>
        </div>
      </div>
    </header>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       BODY
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="chat-body">

      <!-- Sidebar -->
      <aside class="chat-sidebar">
        <div class="sidebar-header">Channels</div>
        <div class="sidebar-room">
          <div class="room-avatar">ğŸŒ</div>
          <div>
            <div class="room-name">General</div>
            <div class="room-desc">Everyone's here</div>
          </div>
        </div>
      </aside>

      <!-- Main chat -->
      <div class="chat-main">

        <!-- Sender identity bar -->
        <div class="sender-bar">
          <label for="senderIdInput">Your User ID</label>
          <input type="number" id="senderIdInput" class="input" placeholder="e.g. 1" min="1" />
          <span class="sender-bar-hint">Enter your user ID to send messages</span>
        </div>

        <!-- Messages -->
        <div class="messages-area" id="messagesArea">

          <div class="date-separator">Today</div>

          {% for msg in messages %}
          <div class="msg-row received" id="msg-{{ msg.id }}">
            <div class="msg-avatar">{{ msg.sender.email|slice:":2"|upper }}</div>
            <div class="msg-content">
              <span class="msg-sender-name">{{ msg.sender.email }}</span>
              <div class="msg-bubble">{{ msg.content }}</div>
              <span class="msg-time">{{ msg.timestamp|date:"H:i" }}</span>
            </div>
          </div>
          {% empty %}
          <div class="empty-state" id="emptyState">
            <div class="empty-state-icon">ğŸ’¬</div>
            <div class="empty-state-title">No messages yet</div>
            <div class="empty-state-desc">Be the first to say something!</div>
          </div>
          {% endfor %}

        </div>

        <!-- Input area -->
        <div class="chat-input-area">
          <div class="chat-input-row">
            <textarea id="messageInput" placeholder="Type a messageâ€¦ (Enter to send, Shift+Enter for new line)" rows="1"
              autocomplete="off"></textarea>
            <button class="send-btn" id="sendBtn" disabled title="Send message">
              â¤
            </button>
          </div>
          <div class="input-hint">Press <kbd
              style="background:var(--surface3);padding:1px 5px;border-radius:4px;font-size:0.7rem;">Enter</kbd> to send
            &nbsp;Â·&nbsp; <kbd
              style="background:var(--surface3);padding:1px 5px;border-radius:4px;font-size:0.7rem;">Shift+Enter</kbd>
            for new line</div>
        </div>

      </div><!-- /chat-main -->
    </div><!-- /chat-body -->
  </div><!-- /chat-page -->

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     JAVASCRIPT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <script>
    /* â”€â”€ DOM refs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    const messagesArea = document.getElementById('messagesArea');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const connBadge = document.getElementById('connBadge');
    const connText = document.getElementById('connText');
    const senderIdInput = document.getElementById('senderIdInput');

    /* â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function showToast(message, type = 'info') {
      const icons = { success: 'âœ…', error: 'âŒ', info: 'â„¹ï¸' };
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `<span class="toast-icon">${icons[type]}</span><span>${message}</span>`;
      container.appendChild(toast);
      setTimeout(() => {
        toast.classList.add('out');
        toast.addEventListener('animationend', () => toast.remove());
      }, 4000);
    }

    /* â”€â”€ Auto-resize textarea â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    messageInput.addEventListener('input', () => {
      messageInput.style.height = 'auto';
      messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
      sendBtn.disabled = messageInput.value.trim() === '';
    });

    /* â”€â”€ WebSocket setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    const wsProtocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
    let ws;
    let reconnectTimer;
    let reconnectDelay = 1000;

    function connectWS() {
      ws = new WebSocket(`${wsProtocol}://${window.location.host}/ws/chat/`);

      ws.onopen = () => {
        connBadge.className = 'connection-badge connected';
        connText.textContent = 'Connected';
        reconnectDelay = 1000;
        showToast('Connected to chat server.', 'success');
      };

      ws.onclose = () => {
        connBadge.className = 'connection-badge disconnected';
        connText.textContent = 'Disconnected';
        // Auto-reconnect with exponential back-off (max 30s)
        reconnectTimer = setTimeout(() => {
          reconnectDelay = Math.min(reconnectDelay * 2, 30000);
          connText.textContent = 'Reconnectingâ€¦';
          connectWS();
        }, reconnectDelay);
      };

      ws.onerror = () => {
        showToast('WebSocket error. Attempting to reconnectâ€¦', 'error');
      };

      ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          appendMessage(data.sender, data.message, false);
        } catch {
          console.warn('Malformed WS message:', event.data);
        }
      };
    }

    connectWS();

    /* â”€â”€ Send message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function sendMessage() {
      const content = messageInput.value.trim();
      const senderId = parseInt(senderIdInput.value, 10);

      if (!content) return;

      if (!senderId || isNaN(senderId)) {
        showToast('Please enter your User ID before sending.', 'error');
        senderIdInput.focus();
        return;
      }

      if (ws.readyState !== WebSocket.OPEN) {
        showToast('Not connected. Please waitâ€¦', 'error');
        return;
      }

      ws.send(JSON.stringify({ message: content, sender_id: senderId }));

      // Optimistically show own message as "sent"
      appendMessage('You', content, true);

      messageInput.value = '';
      messageInput.style.height = 'auto';
      sendBtn.disabled = true;
      messageInput.focus();
    }

    /* â”€â”€ Keyboard shortcuts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    messageInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    sendBtn.addEventListener('click', sendMessage);

    /* â”€â”€ Append a message bubble â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function appendMessage(sender, content, isSelf) {
      // Remove empty state if present
      const empty = document.getElementById('emptyState');
      if (empty) empty.remove();

      const initials = sender.slice(0, 2).toUpperCase();
      const now = new Date();
      const time = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

      const row = document.createElement('div');
      row.className = `msg-row ${isSelf ? 'sent' : 'received'}`;

      row.innerHTML = `
      <div class="msg-avatar">${escapeHtml(initials)}</div>
      <div class="msg-content">
        <span class="msg-sender-name">${escapeHtml(sender)}</span>
        <div class="msg-bubble">${escapeHtml(content)}</div>
        <span class="msg-time">${time}</span>
      </div>
    `;

      messagesArea.appendChild(row);
      scrollToBottom();
    }

    /* â”€â”€ Scroll to bottom â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function scrollToBottom(smooth = true) {
      messagesArea.scrollTo({
        top: messagesArea.scrollHeight,
        behavior: smooth ? 'smooth' : 'instant',
      });
    }

    /* â”€â”€ HTML escape â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    /* â”€â”€ Initial scroll â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    scrollToBottom(false);

    /* â”€â”€ Cleanup on page unload â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    window.addEventListener('beforeunload', () => {
      clearTimeout(reconnectTimer);
      if (ws) ws.close();
    });
  </script>

</body>

</html>